<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>炸弹猫 - 创建/加入房间</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; background:#111; color:#eee; }
    input, select, button { margin: .25rem 0; padding:.5rem; }
    .card { background:#222; padding:1rem; border-radius:8px; max-width:520px; }
    #avatarChoices { display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0; }
    .avatar-opt { width:72px; height:72px; border:2px solid #444; border-radius:8px; overflow:hidden; cursor:pointer; display:flex; align-items:center; justify-content:center; background:#000; }
    .avatar-opt img { width:100%; height:100%; object-fit:cover; }
    .avatar-opt.selected { border-color:#2ecc71; box-shadow:0 0 6px #2ecc71; }
    small { opacity:.7; }
  </style>
</head>
<body>
  <div class="card">
    <h1>炸弹猫 (Prototype)</h1>
    <label>昵称 <br><input id="nickname" maxlength="20" value="玩家"/></label><br>
    <label>自定义头像URL (可选, 若填写将覆盖下方选择)<br><input id="avatar" placeholder="https://..."/></label>
    <div>
      <small>或选择一个预设头像:</small>
      <div id="avatarChoices"></div>
    </div>
    <fieldset style="border:1px solid #444; padding:.5rem;">
      <legend>选项</legend>
      <label><input type="checkbox" id="useExpansion"/> 启用扩展</label><br>
      <label><input type="checkbox" id="includeImploding"/> 包含黑洞(Imploding)</label>
    </fieldset>
    <button id="createBtn">创建房间</button>
    <hr>
    <label>房间ID <br><input id="joinRoomId" placeholder="房间号"/></label><br>
    <button id="joinBtn">加入房间</button>
  </div>
  <script type="module">
    const nicknameInput = document.getElementById('nickname');
    const avatarInput = document.getElementById('avatar');
    const avatarChoicesEl = document.getElementById('avatarChoices');
    const useExpansion = document.getElementById('useExpansion');
    const includeImploding = document.getElementById('includeImploding');

    const presetImages = ['cat1.svg','cat2.svg','cat3.svg'];
    let selectedPreset = null;

    function buildAvatarChoices(){
      presetImages.forEach(name => {
        const div = document.createElement('div');
        div.className = 'avatar-opt';
        div.title = name;
        div.innerHTML = `<img src="/images/${name}" alt="${name}">`;
        div.onclick = () => {
          document.querySelectorAll('.avatar-opt').forEach(e=>e.classList.remove('selected'));
            div.classList.add('selected');
            selectedPreset = `/images/${name}`;
            // 如果用户未填写自定义 URL，则同步显示
            if (!avatarInput.value.trim()) avatarInput.value = selectedPreset;
        };
        avatarChoicesEl.appendChild(div);
      });
    }
    buildAvatarChoices();

    avatarInput.addEventListener('input', ()=>{
      if (avatarInput.value.trim()) {
        // 取消预设选中
        document.querySelectorAll('.avatar-opt').forEach(e=>e.classList.remove('selected'));
        selectedPreset = null;
      }
    });

    const pidKey = 'bomb_player_id';
    let playerId = localStorage.getItem(pidKey);
    if (!playerId) { playerId = crypto.randomUUID(); localStorage.setItem(pidKey, playerId); }

    function goLobby(roomId){
      window.location.href = `/lobby.html?room=${roomId}`;
    }

    async function safeJsonFetch(url, opts){
      const r = await fetch(url, opts);
      try { return await r.json(); } catch { return { ok:false, error:'Invalid JSON' }; }
    }

    document.getElementById('createBtn').onclick = async () => {
      const options = { playerCount: 8, useExpansion: useExpansion.checked, includeImploding: includeImploding.checked };
      const chosenAvatar = avatarInput.value.trim() || selectedPreset || undefined;
      const payload = { playerId, name: nicknameInput.value.trim() || '玩家', avatar: chosenAvatar, options };
      const r = await safeJsonFetch('/api/createRoom', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (r.ok) goLobby(r.roomId); else alert(r.error || '创建失败');
    };

    document.getElementById('joinBtn').onclick = () => {
      const roomId = (document.getElementById('joinRoomId')).value.trim();
      if (!roomId) return;
      goLobby(roomId);
    };
  </script>
</body>
</html>
