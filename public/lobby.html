<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>大厅 - 炸弹猫</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:1rem; background:#10141a; color:#f0f3f5; }
    .row { display:flex; gap:1rem; flex-wrap:wrap; }
    .player { background:#1e252e; padding:.75rem; border-radius:6px; width:140px; position:relative; }
    .player.me { outline:2px solid #2ecc71; }
    .dead { filter:grayscale(1); opacity:.5; }
    button { cursor:pointer; }
    #log { max-height:160px; overflow:auto; background:#0008; padding:.5rem; font-size:.8rem; }
  </style>
</head>
<body>
  <h2>房间 <span id="roomId"></span></h2>
  <div id="controls">
    <button id="startBtn">开始游戏</button>
    <button id="leaveBtn">退出</button>
    <button id="copyBtn">复制邀请链接</button>
  </div>
  <h3>玩家</h3>
  <div class="row" id="players"></div>
  <p>拖动（或点击目标座位按钮）可调整座位（未实现拖动，使用按钮演示）。</p>
  <div id="log"></div>
  <script type="module" src="/client.js"></script>
  <script type="module">
    import { socket, getPlayerId, ensureName, stateBus } from './client.js';

    const url = new URL(location.href);
    const roomParam = url.searchParams.get('room');
    const roomIdEl = document.getElementById('roomId');
    roomIdEl.textContent = roomParam || '';

    const playerId = getPlayerId();
    const name = ensureName();

    function log(msg){ const el = document.getElementById('log'); el.innerHTML += `<div>${new Date().toLocaleTimeString()} ${msg}</div>`; el.scrollTop = el.scrollHeight; }

    socket.emit('joinRoom', { roomId: roomParam, playerId, name }, (ack)=>{ if(!ack?.ok){ alert('加入失败:'+ack.error); location.href='/'; }});

    document.getElementById('startBtn').onclick = () => {
      socket.emit('startGame', { roomId: roomParam, playerId }, (ack)=>{ if(!ack.ok) alert('无法开始'); else location.href=`/game.html?room=${roomParam}`; });
    };
    document.getElementById('leaveBtn').onclick = () => { location.href='/'; };
    document.getElementById('copyBtn').onclick = () => { navigator.clipboard.writeText(location.href).then(()=>alert('已复制房间链接')); };

    stateBus.on('roomUpdate', payload => {
      renderPlayers(payload.state.players);
    });

    function renderPlayers(players){
      const wrap = document.getElementById('players');
      wrap.innerHTML='';
      players.forEach((p,i)=>{
        const div = document.createElement('div');
        div.className='player'+(p.id===playerId?' me':'');
        div.innerHTML = `<strong>#${i}</strong><br>${p.name}<br><small>${p.alive?'存活':'出局'}</small><br>`;
        const btn = document.createElement('button');
        btn.textContent='换到此位';
        btn.onclick=()=>{
          socket.emit('swapSeat',{ roomId: roomParam, playerId, targetSeat:i }, ack=>{ if(!ack.ok) alert('无法换位'); });
        };
        div.appendChild(btn);
        wrap.appendChild(div);
      });
    }
  </script>
</body>
</html>
